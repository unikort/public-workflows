# == variables (GitHub environments are required) ==
# (optional) CI_DOCKER_CONTEXT: path to context dir (e.g. src/). Default: .
# (optional) CI_DOCKERFILE:     path to Dockerfile (e.g. build/Dockerfile). Default: Dockerfile
# (optional) CI_BUILD_ARGS:     any addidional args like --build-arg (in one line)
#
# docs: https://github.com/unikort/public-workflows/wiki/Docker-CI

name: "Reusable workflow docker-ci"

on:
  workflow_call:
        
env:
  version: ${{ inputs.version }}
  repo: ${{ github.event.repository.name }}

jobs:
  ci:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      
      - uses: actions/checkout@v4
        
      - name: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸
        run: |
          # get newest version from container registry
          GHCR_TOKEN=$(echo ${{ github.token }} | base64)
          json=$(curl -s -H "Authorization: Bearer $GHCR_TOKEN" https://ghcr.io/v2/${{ github.repository }}/tags/list)
          
          # if it's first release (older releases doesn't exist)
          if ! echo "$json" | grep -q "tags" || echo "$json" | grep -q "NAME_UNKNOWN"; then
            echo "prev_major=0" >> $GITHUB_ENV
            echo "prev_minor=0" >> $GITHUB_ENV
            echo "prev_patch=0" >> $GITHUB_ENV
          else
            tmp=$(echo $json | jq -r '[.tags.[]]
                                            | map(select(test("v[0-9]+\\.[0-9]+\\.[0-9]+")))  # only vX.Y.Z
                                            | map(gsub("[^0-9.]"; ""))                        # -> X.Y.Z
                                            | unique
                                            | sort_by(split(".") | map(tonumber?))            # sort by each number
                                            | last')

            echo "prev_major=$(echo $tmp | cut -d. -f1)" >> $GITHUB_ENV
            echo "prev_minor=$(echo $tmp | cut -d. -f2)" >> $GITHUB_ENV
            echo "prev_patch=$(echo $tmp | cut -d. -f3)" >> $GITHUB_ENV
          fi

      - name: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸
        run: |
          if [[ ${{ env.version }} == "vX.Y.Z" ]]; then
            echo "major=$prev_major" >> $GITHUB_ENV
            echo "minor=$prev_minor" >> $GITHUB_ENV
            echo "patch=$(( $prev_patch + 1 ))" >> $GITHUB_ENV
          elif [[ ${{ env.version }} =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            tmp=${{ env.version }}
            tmp="${tmp#v}"
            echo "major=$(echo $tmp | cut -d. -f1)" >> $GITHUB_ENV
            echo "minor=$(echo $tmp | cut -d. -f2)" >> $GITHUB_ENV
            echo "patch=$(echo $tmp | cut -d. -f3)" >> $GITHUB_ENV
          else
            echo "::warning::ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð²ÐµÑ€ÑÐ¸Ð¸. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ vX.Y.Z"
            exit 1
          fi

      - name: Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸
        run: |          
          if (( prev_major > major )) || 
             (( prev_major == major && prev_minor > minor )) || 
             (( prev_major == major && prev_minor == minor && prev_patch >= patch )); then
            echo "::warning::Ð£Ð¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ñ€ÐµÐ»Ð¸Ð· Ñ Ñ‚Ð°ÐºÐ¾Ð¹ Ð¶Ðµ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹ Ð¸Ð»Ð¸ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹ Ð²Ñ‹ÑˆÐµ"
            exit 1
          fi

      - name: Ð ÐµÐ½Ð´ÐµÑ€ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ñ‚ÐµÐ³Ð°
        run: |
          new_tag="v$major.$minor.$patch-${{ github.ref_name }}"
          echo "new_tag=$new_tag" >> $GITHUB_ENV
          echo "::notice title=ðŸ³ Docker image tag::$new_tag"

      - run: |
          echo "::debug::CI_BUILD_ARGS start>>${{ vars.CI_BUILD_ARGS }}<<end"
    
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ github.token }}

      - name: Build and push
        run: |
          docker build ${{ vars.CI_BUILD_ARGS }} -t ghcr.io/${{ github.repository }}:$new_tag -f ${{ vars.CI_DOCKERFILE || 'Dockerfile' }} ${{ vars.CI_DOCKER_CONTEXT || '.' }}
          docker push ghcr.io/${{ github.repository }}:$new_tag
