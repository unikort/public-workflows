# == variables (Repository-wide) ==
# (optional) CD_RUNNER:      Actions runner to use.  Default: "self-hosted"
# == variables (Deployment environments) ==
# CD_SERVER:       address of server to deploy
# CD_COMPOSE_FILE: path to .yaml file for docker compose
# (optional) CD_VOLUMES_DIR: path to directory that will also transfer to server along with the compose file
# (optional) CD_SSH_USER:    user to connect under.  Default: "worker"
# (optional) CD_SSH_OPTS:    additional SSH options. Default: "-o StrictHostKeyChecking=no"
# == secrets ==
# CD_SSH_KEY: private SSH key
#
# docs: https://github.com/unikort/public-workflows/wiki/Docker-Compose-CD

name: "Reusable workflow Docker Compose CD"

on:
  workflow_call:
    secrets:
      CD_SSH_KEY:
        required: true
  
env:
  repo: ${{ github.event.repository.name }}
  dest: "/opt/compose/"
  ssh_user: ${{ vars.CD_SSH_USER || 'worker' }}
  ssh_opts: ${{ vars.CD_SSH_OPTS || '-o StrictHostKeyChecking=no' }}

jobs:    
  deploy:
    name: 'deploy to docker compose server'
    environment: ${{ inputs.environment }}
    runs-on: ${{ vars.CD_RUNNER || 'self-hosted' }}
    steps:
    
      - name: 'Add SSH key'
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.CD_SSH_KEY }}

      - uses: actions/checkout@v4

      - name: Assertion
        run: |
          if [ ! -n "${{ vars.CD_SERVER }}" ]; then
            echo "::warning title=Variable CD_SERVER not found::Set it: Settings -> Environments -> Variables"
            exit 1
          fi

          if [ ! -n "${{ vars.CD_COMPOSE_FILE }}" ]; then
            echo "::warning title=Variable CD_COMPOSE_FILE not found::Set it: Settings -> Environments -> Variables"
            exit 1
          fi

          if [ ! -f "${{ vars.CD_COMPOSE_FILE }}" ]; then
            echo "::warning title=Compose file not found:: ${{ vars.CD_COMPOSE_FILE }}"
            exit 1
          fi

          if [ -n "${{ vars.CD_VOLUMES_DIR }}" ]; then
            echo "::notice title=üìÅ Volumes dir::${{ vars.CD_VOLUMES_DIR }}"
            if [ ! -d "${{ vars.CD_VOLUMES_DIR }}" ]; then
              echo "::warning title=CD_VOLUMES_DIR is set but directory not found:: ${{ vars.CD_VOLUMES_DIR }}"
              exit 1
            fi
          fi

      - name: Notification
        run: |
          echo "::notice title=üöö Deploy to::${{ vars.CD_SERVER }}:${{ env.dest }}${{ env.repo }}/"
          echo "::notice title=üê≥ Compose file::${{ vars.CD_COMPOSE_FILE }}"

      - name: '–û—Ç–ø—Ä–∞–≤–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä ${{ vars.CD_SERVER }}'
        run: |
          set -euo pipefail

          mkdir tmp/
          mv "${{ vars.CD_COMPOSE_FILE }}" tmp/

          if [ -n "${{ vars.CD_VOLUMES_DIR }}" ]; then
            mv "${{ vars.CD_VOLUMES_DIR }}" tmp/
          fi

          rsync -avzP --delete --stats --human-readable \
          -e "ssh ${{ env.ssh_opts }}" \
            tmp/ \
            "${{ env.ssh_user }}@${{ vars.CD_SERVER }}:${{ env.dest }}${{ env.repo }}/"


      - name: '–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞'
        run: |
          ssh ${{ env.ssh_opts }} ${{ env.ssh_user }}@${{ vars.CD_SERVER }} << 'EOF'
          echo '${{ github.token }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          cd ${{ env.dest }}${{ env.repo }}
          export IMAGE_TAG=${{ inputs.image_tag }}
          docker compose pull
          docker compose -f ${{ vars.CD_COMPOSE_FILE }} up -d --pull always --force-recreate
          docker logout ghcr.io
          EOF
